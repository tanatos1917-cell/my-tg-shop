<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Telegram Mini Shop</title>
    <!-- Подключение Telegram Web App API -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        /* 
           ОСНОВНЫЕ СТИЛИ 
           Используем CSS-переменные Telegram для адаптации под тему пользователя
        */
        :root {
            --bg-color: var(--tg-theme-bg-color, #fff);
            --text-color: var(--tg-theme-text-color, #000);
            --hint-color: var(--tg-theme-hint-color, #999);
            --link-color: var(--tg-theme-link-color, #2481cc);
            --button-color: var(--tg-theme-button-color, #2481cc);
            --button-text-color: var(--tg-theme-button-text-color, #fff);
            --secondary-bg-color: var(--tg-theme-secondary-bg-color, #f4f4f5);
        }

        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            -webkit-tap-highlight-color: transparent; /* Убирает подсветку при клике на мобильных */
        }

        .container {
            padding: 16px;
            max-width: 600px;
            margin: 0 auto;
        }

        h1 {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 20px;
            text-align: center;
        }

        /* СЕТКА ТОВАРОВ */
        .product-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr); /* 2 товара в ряд */
            gap: 12px;
        }

        /* КАРТОЧКА ТОВАРА */
        .product-card {
            background-color: var(--secondary-bg-color); /* Фон чуть темнее/светлее основы */
            border-radius: 12px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding-bottom: 12px;
            transition: transform 0.1s ease;
            position: relative;
        }

        .product-img {
            width: 100%;
            height: 120px;
            object-fit: cover;
            display: block;
        }

        .product-info {
            padding: 10px;
            text-align: center;
            width: 100%;
            box-sizing: border-box;
        }

        .product-name {
            font-size: 14px;
            font-weight: 600;
            margin: 0 0 4px 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .product-price {
            font-size: 13px;
            color: var(--hint-color);
            font-weight: 500;
        }

        /* УПРАВЛЕНИЕ КОЛИЧЕСТВОМ (+ и -) */
        .btn-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-top: auto; /* Прижимает кнопки к низу карточки */
        }

        .add-btn {
            background-color: var(--button-color);
            color: var(--button-text-color);
            border: none;
            padding: 8px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            width: 80%;
        }

        .counter-controls {
            display: flex;
            align-items: center;
            background-color: var(--button-color);
            border-radius: 8px;
            padding: 2px;
        }

        .control-btn {
            background: none;
            border: none;
            color: var(--button-text-color);
            font-size: 18px;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        .count-value {
            color: var(--button-text-color);
            font-size: 14px;
            font-weight: 600;
            min-width: 20px;
            text-align: center;
        }
        
        /* Анимация нажатия */
        .product-card:active {
            transform: scale(0.98);
        }
    </style>
</head>
<body>

    <div class="container">
        <h1>Каталог</h1>
        <div class="product-grid" id="productList">
            <!-- Товары будут добавлены сюда через JS -->
        </div>
    </div>

    <script>
        // --- 1. ИНИЦИАЛИЗАЦИЯ TELEGRAM WEB APP ---
        const tg = window.Telegram.WebApp;

        // Сообщаем Telegram, что приложение готово
        tg.ready();
        
        // Разворачиваем на весь экран
        tg.expand(); 

        // Основная кнопка (MainButton) - изначально скрыта
        const mainBtn = tg.MainButton;
        mainBtn.setText("Оплатить");
        mainBtn.textColor = "#FFFFFF";
        mainBtn.color = "#2481cc"; // fallback color

        // Обновляем цвета кнопки в соответствии с темой (если параметры доступны)
        if (tg.themeParams && tg.themeParams.button_color) {
            mainBtn.color = tg.themeParams.button_color;
            mainBtn.textColor = tg.themeParams.button_text_color;
        }

        // --- 2. ДАННЫЕ (ТОВАРЫ) ---
        // Используем плейсхолдеры для картинок с текстом
        const products = [
            { id: 1, name: 'Чизбургер', price: 250, image: 'https://placehold.co/300x200/orange/white?text=Burger' },
            { id: 2, name: 'Картофель Фри', price: 150, image: 'https://placehold.co/300x200/gold/white?text=Fries' },
            { id: 3, name: 'Кола 0.5л', price: 100, image: 'https://placehold.co/300x200/black/white?text=Cola' },
            { id: 4, name: 'Наггетсы', price: 200, image: 'https://placehold.co/300x200/brown/white?text=Nuggets' }
        ];

        // Корзина: объект { id_товара: количество }
        let cart = {};

        // --- 3. ЛОГИКА ОТРИСОВКИ ---
        const listElement = document.getElementById('productList');

        function renderProducts() {
            listElement.innerHTML = ""; // Очищаем список перед перерисовкой

            products.forEach(item => {
                const quantity = cart[item.id] || 0;
                
                // Создаем карточку
                const card = document.createElement('div');
                card.className = 'product-card';

                // Определяем, что показывать: кнопку "Добавить" или "+ счетчик -"
                let buttonHTML;
                if (quantity === 0) {
                    buttonHTML = `<button class="add-btn" onclick="addToCart(${item.id})">Добавить</button>`;
                } else {
                    buttonHTML = `
                        <div class="counter-controls">
                            <button class="control-btn" onclick="removeFromCart(${item.id})">-</button>
                            <span class="count-value">${quantity}</span>
                            <button class="control-btn" onclick="addToCart(${item.id})">+</button>
                        </div>
                    `;
                }

                card.innerHTML = `
                    <img src="${item.image}" alt="${item.name}" class="product-img">
                    <div class="product-info">
                        <div class="product-name">${item.name}</div>
                        <div class="product-price">${item.price} ₽</div>
                    </div>
                    <div class="btn-container">
                        ${buttonHTML}
                    </div>
                `;

                listElement.appendChild(card);
            });
        }

        // --- 4. УПРАВЛЕНИЕ КОРЗИНОЙ ---

        // Добавить товар (+)
        window.addToCart = function(id) {
            if (!cart[id]) {
                cart[id] = 1;
            } else {
                cart[id]++;
            }
            updateMainButton();
            renderProducts();
            
            // Вибрация для тактильного отклика (Haptic Feedback)
            tg.HapticFeedback.impactOccurred('light');
        };

        // Убрать товар (-)
        window.removeFromCart = function(id) {
            if (cart[id]) {
                cart[id]--;
                if (cart[id] === 0) {
                    delete cart[id];
                }
            }
            updateMainButton();
            renderProducts();
            
            tg.HapticFeedback.impactOccurred('light');
        };

        // --- 5. ЛОГИКА MAIN BUTTON ---
        function updateMainButton() {
            let totalSum = 0;
            let totalItems = 0;

            // Считаем сумму и количество
            for (const [id, qty] of Object.entries(cart)) {
                const product = products.find(p => p.id == id);
                if (product) {
                    totalSum += product.price * qty;
                    totalItems += qty;
                }
            }

            if (totalItems > 0) {
                mainBtn.setText(`Оплатить ${totalSum} ₽`);
                if (!mainBtn.isVisible) {
                    mainBtn.show();
                }
            } else {
                mainBtn.hide();
            }
        }

        // Обработка клика по MainButton
        tg.onEvent('mainButtonClicked', function(){
            // Формируем данные для отправки боту
            const data = JSON.stringify(cart);
            
            // Отправляем данные и закрываем Web App
            tg.sendData(data); 
        });

        // Первичная отрисовка
        renderProducts();

    </script>
</body>
</html>
